name: Release Production

on:
  push:
    branches: [release/production]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to deploy (optional). If empty, uses the selected ref in the UI or the commit that triggered the run"
        required: false

jobs:
  remove-old-artifact:
    name: ğŸ—‘ï¸ Remove Old Artifacts
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ğŸ§ª Test SSH Connection
        run: |
          echo "ğŸ‘‰ Testing SSH connection to production server..."
          sshpass -p "${{ secrets.HUAWEI_CLOUD_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.HUAWEI_CLOUD_USERNAME }}@${{ secrets.HUAWEI_CLOUD_HOST }} "echo 'âœ… SSH Success'" || echo "âŒ SSH Failed"

  build:
    name: "ğŸ”¨ Build on Runner"
    needs: remove-old-artifact
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag != '' && format('refs/tags/{0}', inputs.tag) || github.ref }}
      - run: |
          echo "ğŸ‘‰ Picked ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag != '' && format('refs/tags/{0}', inputs.tag) || github.ref }}"

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: echo "ğŸ‘‰ Node.js 20 is ready with npm cache enabled"

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          echo "ğŸ‘‰ Installing dependencies..."
          npm ci

      - name: "âš™ï¸ Prisma Generate"
        run: |
          echo "ğŸ‘‰ Generating Prisma client..."
          npx prisma generate --schema=prisma/schema.prisma
          npx prisma generate --schema=prisma/timesheet/schema.prisma


      - name: "ğŸ—ï¸ Build Project"
        run: |
          echo "ğŸ‘‰ Building project..."
          npm run build

      - name: "ğŸ“¤ Archive Build Artifacts"
        run: |
          echo "ğŸ‘‰ Archiving build artifacts..."
          zip -r build.zip \
            .next \
            public \
            generated/prisma \
            package.json \
            package-lock.json \
            next.config.mjs

      - name: "â¬†ï¸ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: build.zip

      - name: "âœ… Confirm Upload"
        run: echo "âœ… Build artifacts uploaded"

  deploy:
    name: "ğŸšš Deploy to Server"
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: "ğŸ—‘ï¸ Delete old deployment folder"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          script: |
            echo "ğŸ‘‰ Removing old deployment files..."
            rm -rf /var/www/sb-web-helper/*

      - name: "ğŸ“¥ Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: "âœ… Confirm Download"
        run: echo "âœ… Build artifacts downloaded"

      - name: "ğŸ” Copy to Server via SCP"
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          source: "build.zip"
          target: "/var/www/sb-web-helper"

      - name: "âœ… Confirm Upload"
        run: echo "âœ… Build.zip uploaded to server"

      - name: "ğŸ—œï¸ Unzip & Install on Server"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          script: |
            echo "ğŸ‘‰ Extracting build.zip and installing production dependencies..."
            cd /var/www/sb-web-helper
            unzip -o build.zip
            npm install
            echo "ğŸ‘‰ Restarting service..."
            sudo systemctl restart sb-web-helper.service
            echo "âœ… Deployment completed!"
