name: Release Production

on:
  push:
    branches: [release/production]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to deploy (optional). If empty, uses the selected ref in the UI or the commit that triggered the run"
        required: false

jobs:
  remove-old-artifact:
    name: 🗑️ Remove Old Artifacts
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: 🧪 Test SSH Connection
        run: |
          echo "👉 Testing SSH connection to production server..."
          sshpass -p "${{ secrets.HUAWEI_CLOUD_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.HUAWEI_CLOUD_USERNAME }}@${{ secrets.HUAWEI_CLOUD_HOST }} "echo '✅ SSH Success'" || echo "❌ SSH Failed"

  build:
    name: "🔨 Build on Runner"
    needs: remove-old-artifact
    runs-on: ubuntu-latest

    steps:
      - name: "📥 Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag != '' && format('refs/tags/{0}', inputs.tag) || github.ref }}
      - run: |
          echo "👉 Picked ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag != '' && format('refs/tags/{0}', inputs.tag) || github.ref }}"

      - name: "⚙️ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: echo "👉 Node.js 20 is ready with npm cache enabled"

      - name: "📦 Install Dependencies"
        run: |
          echo "👉 Installing dependencies..."
          npm ci

      - name: "⚙️ Prisma Generate"
        run: |
          echo "👉 Generating Prisma client..."
          npx prisma generate --schema=prisma/schema.prisma
          npx prisma generate --schema=prisma/timesheet/schema.prisma


      - name: "🏗️ Build Project"
        run: |
          echo "👉 Building project..."
          npm run build

      - name: "📤 Archive Build Artifacts"
        run: |
          echo "👉 Archiving build artifacts..."
          zip -r build.zip \
            .next \
            public \
            generated/prisma \
            package.json \
            package-lock.json \
            next.config.mjs

      - name: "⬆️ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: build.zip

      - name: "✅ Confirm Upload"
        run: echo "✅ Build artifacts uploaded"

  deploy:
    name: "🚚 Deploy to Server"
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: "🗑️ Delete old deployment folder"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          script: |
            echo "👉 Removing old deployment files..."
            rm -rf /var/www/sb-web-helper/*

      - name: "📥 Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: "✅ Confirm Download"
        run: echo "✅ Build artifacts downloaded"

      - name: "🔐 Copy to Server via SCP"
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          source: "build.zip"
          target: "/var/www/sb-web-helper"

      - name: "✅ Confirm Upload"
        run: echo "✅ Build.zip uploaded to server"

      - name: "🗜️ Unzip & Install on Server"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          script: |
            echo "👉 Extracting build.zip and installing production dependencies..."
            cd /var/www/sb-web-helper
            unzip -o build.zip
            npm install
            echo "👉 Restarting service..."
            sudo systemctl restart sb-web-helper.service
            echo "✅ Deployment completed!"
