name: ğŸš€ Release Tag Version

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to deploy (optional, e.g. 1.0.0). If empty = deploy current commit on main"
        required: false

jobs:
  build:
    name: "ğŸ”¨ Build on Runner"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag }}

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "ğŸ“¦ Install Dependencies"
        run: npm ci

      - name: "âš™ï¸ Prisma Generate"
        run: npx prisma generate --schema=prisma/schema.prisma

      - name: "ğŸ—ï¸ Build Project"
        run: npm run build

      - name: "ğŸ“¤ Archive Build Artifacts"
        run: |
          zip -r build.zip \
            .next \
            public \
            generated/prisma \
            package.json \
            package-lock.json \
            next.config.mjs

      - name: "â¬†ï¸ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: build.zip

  deploy:
    name: "ğŸšš Deploy to Server"
    runs-on: ubuntu-latest
    needs: build
    environment: production

    steps:
      - name: "ğŸ—‘ï¸ Delete old deployment folder"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          script: |
            rm -rf /var/www/sb-web-helper/*

      - name: "ğŸ“¥ Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: "ğŸ” Copy to Server via SCP"
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          source: "build.zip"
          target: "/var/www/sb-web-helper"

      - name: "ğŸ—œï¸ Unzip & Install on Server"
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.HUAWEI_CLOUD_HOST }}
          username: ${{ secrets.HUAWEI_CLOUD_USERNAME }}
          password: ${{ secrets.HUAWEI_CLOUD_PASSWORD }}
          port: ${{ secrets.HUAWEI_CLOUD_SSH_PORT }}
          script: |
            cd /var/www/sb-web-helper
            unzip -o build.zip
            npm install --production
            sudo systemctl restart sb-web-helper.service